<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Timeclock</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="origin-trial" content="AuaQeeuqFR0yP8cgkbps1BwUshdwaJBNKvEiXamR2ZMl3tnebvt1fOqwY5">
  <link rel="manifest" href="manifest.json">
  <style>
    html, body {
      height: 100%;
      background: black;
    }
    body {
      margin: 0;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }
    body > header {
      display: flex;
      font-size: 24px;
    }
    body > header > * {
      padding: 12px;
    }
    body > div.table {
      display: grid;
      grid-gap: 10px;
      grid-template-columns: auto auto auto auto;
      padding: 8px 20px;
    }
    body > div.table > div.total {
      justify-self: end;
    }
  </style>
</head>
<body>
  <script src="https://unpkg.com/@reactivex/rxjs@6.1/dist/global/rxjs.umd.js"></script>
  <script type="module">
    // import {html, repeat, render} from './node_modules/lit-html/lit-html.js';
    // import {repeat} from 'lit-html/directives/repeat.js';
    import { html, render } from 'https://unpkg.com/lit-html?module';
    import { repeat } from 'https://unpkg.com/lit-html/directives/repeat.js?module';
    const { WebSocketSubject } = rxjs.webSocket;
    const { switchMap, startWith, map } = rxjs.operators;
    const { empty, interval } = rxjs;

    const RECENT_THRESHOLD = 3.6e6 * 2 // 2 hours

    const socket = new WebSocketSubject(`ws://${window.location.host}/socket`);

    const employeeName = (empl) => html`${empl['FullName']}`;
    
    const formatDuration = (f) => {
      const hours = Math.floor(f / 3.6e6);
      f -= hours * 3.6e6;
      const minutes = Math.floor(f / 6e4);
      f -= minutes * 6e4;
      const seconds = Math.floor(f / 1e3);
      let s;
      if (hours > 0) {
        s = hours + ':' + ('0' + minutes).slice(-2);
      } else {
        s = minutes;
      }
      return s + '.' + ('0' + seconds).slice(-2);
    };

    const formatTime = (d, ms = false) => {
      const h = d.getHours();
      const mm = ('0' + d.getMinutes()).slice(-2);
      let s = `${h}:${mm}`;
      if (ms) {
        s += '.' + ('0' + d.getSeconds()).slice(-2);
      }
      return s;
    };

    const shiftTime = (d) => html`
      <span>${d ? formatTime(d) : 'None'}</span>	`;
    
    const summary = (now, lastPoll, nextPoll) => html`
      <div>${formatTime(now, true)}</div>
      <div>As of ${formatTime(lastPoll) + (lastPoll.getDate() != now.getDate() ? ' (' + (lastPoll.getMonth() + 1) + '/' + ('0' + lastPoll.getDate()).slice(-2) + ')' : '')}</div>
      <div>Next update: ${formatTime(nextPoll)}${nextPoll < now ? ' (LATE)' : ''}</div>
    `;
    const header = html`<div>Name</div><div>Clock In</div><div>Clock Out</div><div class="total">Total</div>`;
    
    const rows = (items, now) => html`
      ${repeat(items, (item) => item['Id'], (item, index) => html`
        <div>${employeeName(item['Employee'])}</div>
        <div>
          ${shiftTime(item['StartDate'])}
          ${item['StartDate'].getDate() != now.getDate() ? html`<span>(${item['StartDate'].getMonth() + 1}/${item['StartDate'].getDate()})</span>`: ''}
        </div>
        <div>${shiftTime(item['EndDate'])}</div>
        <div class="total">${formatDuration((item['EndDate'] || now) - item['StartDate'])}</div>
      `)}
      `;
    
    const template = (data, now) => html`
    <header>${summary(now, data.lastPoll, data.nextPoll)}</header>
    <div class="table">
      ${header}
      ${rows(data.filteredShifts, now)}
    </div>`;

    let timeout;
    socket.pipe(switchMap(drawAndUpdate)).subscribe();

    function drawAndUpdate(data) {
      console.log('data', data);
      if (!data || !data.shifts || !data.employees) {
        return empty();
      }

      data['lastPoll'] = new Date(data['lastPoll']);
      data['nextPoll'] = new Date(data['nextPoll']);
      data['nextRetry'] = new Date(data['nextRetry']);
      for (const shift of data.shifts) {
        shift['StartDate'] = new Date(shift['StartDate']);
        shift['EndDate'] = shift['EndDate'] ? new Date(shift['EndDate']) : null;
      }
      return interval(1000).pipe(
        startWith(0),
        map(() => {
          const now = new Date();
          data.filteredShifts = data.shifts
            .filter(({EndDate}) => EndDate == null || now - EndDate < RECENT_THRESHOLD)
            .sort(sortBy(['StartDate', 'EndDate', 'EmployeeId']))
            .map(shift => ({...shift, Employee: data.employees[shift['EmployeeId']]}));
          render(template(data, now), document.body);
        }),
      );
    }


    function sortBy(keys) {
      return function(a, b) {
        for (const key of keys) {
          if (a[key] < b[key]) return -1;
          if (a[key] > b[key]) return 1;
        }
        return 0;
      }
    }

    (async function() {
      try {
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release', () => {
          console.info('Wake Lock was released');
        });
        console.info('Wake Lock is active');
      } catch (err) {
        console.info('Wake Lock is inactive');
      }
    })();
  </script>
</body>
</html>
